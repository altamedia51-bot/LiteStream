
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteStream SaaS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; margin: 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-link.active { background: rgba(79, 70, 229, 0.1); color: #818cf8; border-right: 3px solid #6366f1; }
        #main-app { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <!-- Auth View -->
    <div id="login-view" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-6">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-md rounded-[2.5rem] p-10 space-y-8 shadow-2xl">
            <div class="text-center">
                <h2 id="auth-title" class="text-2xl font-bold">LiteStream Login</h2>
                <p id="auth-subtitle" class="text-slate-500 text-sm">Kelola stream Anda dengan paket hemat</p>
            </div>
            <form id="login-form" onsubmit="handleAuth(event, 'login')" class="space-y-4">
                <input type="text" id="login-user" required class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3.5 text-sm text-white" placeholder="Username">
                <input type="password" id="login-pass" required class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3.5 text-sm text-white" placeholder="Password">
                <button type="submit" id="login-btn" class="w-full py-4 bg-indigo-600 rounded-2xl font-bold shadow-xl transition-all hover:bg-indigo-500">SIGN IN</button>
                <p class="text-center text-xs text-slate-500">Belum punya akun? <a href="#" onclick="toggleAuthMode()" class="text-indigo-400">Daftar Trial</a></p>
            </form>
            <div id="auth-error" class="hidden text-rose-500 text-xs text-center p-3 bg-rose-500/10 rounded-xl border border-rose-500/20"></div>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="main-app" class="flex flex-col md:flex-row min-h-screen">
        <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col p-6">
            <h1 class="font-bold text-xl mb-10 flex items-center gap-2"><i class="fas fa-bolt text-indigo-500"></i> LiteStream</h1>
            <nav class="space-y-2 flex-1">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 active"><i class="fas fa-chart-pie"></i> Overview</button>
                <button onclick="switchTab('library')" id="nav-library" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400"><i class="fas fa-folder"></i> Media</button>
                <button onclick="switchTab('users')" id="nav-users" class="nav-link hidden w-full items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400"><i class="fas fa-user-shield"></i> Users</button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400"><i class="fas fa-cog"></i> Settings</button>
            </nav>
            <button onclick="handleLogout()" class="mt-auto text-rose-400 text-sm font-bold flex items-center gap-2 px-4 py-3 hover:bg-rose-500/10 rounded-xl"><i class="fas fa-power-off"></i> Logout</button>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            <!-- Quota Widget (Always Visible Header) -->
            <div id="quota-widget" class="bg-slate-800 border border-slate-700 rounded-3xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Paket Saat Ini</p>
                    <h3 id="plan-name-display" class="text-xl font-bold text-indigo-400">Loading...</h3>
                </div>
                <div class="flex-1 max-w-md w-full space-y-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase">
                        <span class="text-slate-400">Penyimpanan Terpakai</span>
                        <span id="storage-text" class="text-slate-200">0 / 0 MB</span>
                    </div>
                    <div class="h-2 bg-slate-900 rounded-full overflow-hidden">
                        <div id="storage-bar" class="h-full bg-indigo-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <button onclick="alert('Hubungi admin untuk upgrade!')" class="bg-emerald-600/10 text-emerald-500 border border-emerald-500/20 px-6 py-2 rounded-xl text-xs font-bold hover:bg-emerald-600 hover:text-white transition-all">UPGRADE PLAN</button>
            </div>

            <div id="tab-overview" class="tab-content active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700">
                        <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Fitur Paket</h4>
                        <ul id="plan-features" class="space-y-3 text-sm text-slate-300">
                            <!-- Feature List -->
                        </ul>
                    </div>
                    <div class="bg-slate-950 p-6 rounded-3xl border border-slate-700 h-64 overflow-y-auto font-mono text-[10px]" id="logConsole">
                        <p class="text-slate-600">-- Menunggu aktivitas stream --</p>
                    </div>
                </div>
            </div>

            <div id="tab-library" class="tab-content space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Media Library</h2>
                    <button onclick="document.getElementById('file-up').click()" class="bg-indigo-600 px-6 py-2.5 rounded-xl font-bold text-sm">Upload File</button>
                    <input type="file" id="file-up" class="hidden" onchange="handleUpload(this)">
                </div>
                <div id="media-list" class="grid grid-cols-1 gap-3"></div>
            </div>

            <div id="tab-users" class="tab-content space-y-6">
                <h2 class="text-2xl font-bold">User & Plan Management</h2>
                <div class="bg-slate-800 rounded-3xl overflow-hidden border border-slate-700">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/50 text-[10px] uppercase font-bold text-slate-500">
                            <tr>
                                <th class="p-4">User</th>
                                <th class="p-4">Paket</th>
                                <th class="p-4">Storage</th>
                                <th class="p-4 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Upgrade Modal (Admin Only) -->
    <div id="upgradeModal" class="hidden fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-[200] flex items-center justify-center p-6">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-3xl p-8 space-y-6">
            <h3 class="text-xl font-bold">Upgrade User Plan</h3>
            <p id="upgrade-user-name" class="text-sm text-slate-400">User: -</p>
            <select id="plan-select" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-sm"></select>
            <div class="flex gap-4">
                <button onclick="closeUpgradeModal()" class="flex-1 py-3 border border-slate-700 rounded-xl text-sm">Batal</button>
                <button onclick="submitUpgrade()" class="flex-1 py-3 bg-indigo-600 rounded-xl text-sm font-bold">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let authMode = 'login';
        let currentUpgradeUserId = null;

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            document.getElementById('auth-title').textContent = authMode === 'login' ? 'LiteStream Login' : 'LiteStream Register';
            document.getElementById('auth-subtitle').textContent = authMode === 'login' ? 'Kelola stream Anda dengan paket hemat' : 'Dapatkan akses trial 500MB hari ini';
            document.querySelector('p.text-center.text-xs.text-slate-500').innerHTML = authMode === 'login' 
                ? 'Belum punya akun? <a href="#" onclick="toggleAuthMode()" class="text-indigo-400">Daftar Trial</a>'
                : 'Sudah punya akun? <a href="#" onclick="toggleAuthMode()" class="text-indigo-400">Login Saja</a>';
            document.getElementById('login-btn').textContent = authMode === 'login' ? 'SIGN IN' : 'CREATE ACCOUNT';
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/check-auth');
                const data = await res.json();
                if (data.authenticated) {
                    currentUser = data.user;
                    showDashboard();
                } else {
                    document.getElementById('login-view').classList.remove('hidden');
                }
            } catch (e) {
                console.error("Auth check failed:", e);
                document.getElementById('login-view').classList.remove('hidden');
            }
        }

        function showDashboard() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('plan-name-display').textContent = currentUser.plan_name;
            
            // Render Quota
            const usedMB = (currentUser.storage_used / (1024 * 1024)).toFixed(1);
            const totalMB = currentUser.max_storage_mb;
            const percent = (usedMB / totalMB) * 100;
            
            document.getElementById('storage-text').textContent = `${usedMB} / ${totalMB} MB`;
            const bar = document.getElementById('storage-bar');
            bar.style.width = percent + '%';
            bar.className = `h-full transition-all duration-500 ${percent > 90 ? 'bg-rose-500' : (percent > 70 ? 'bg-amber-500' : 'bg-indigo-500')}`;

            // Features List
            const feats = document.getElementById('plan-features');
            feats.innerHTML = `
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-indigo-400"></i> Max Streams: ${currentUser.max_active_streams}</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-indigo-400"></i> Allowed: ${currentUser.allowed_types.toUpperCase()}</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-indigo-400"></i> SaaS Cloud Storage</li>
            `;

            if (currentUser.role === 'admin') document.getElementById('nav-users').classList.remove('hidden');
            fetchMedia();
        }

        async function handleAuth(e, mode) {
            e.preventDefault();
            const username = document.getElementById('login-user').value;
            const password = document.getElementById('login-pass').value;
            const errEl = document.getElementById('auth-error');
            
            errEl.classList.add('hidden');
            
            try {
                const res = await fetch(`/api/${authMode}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                
                if (data.success) {
                    if (authMode === 'register') {
                        alert(data.message);
                        toggleAuthMode();
                    } else {
                        location.reload();
                    }
                } else {
                    errEl.textContent = data.error || "Gagal melakukan aksi";
                    errEl.classList.remove('hidden');
                }
            } catch (err) {
                errEl.textContent = "Koneksi ke server terputus.";
                errEl.classList.remove('hidden');
            }
        }

        async function fetchMedia() {
            const res = await fetch('/api/videos');
            const data = await res.json();
            document.getElementById('media-list').innerHTML = data.map(v => `
                <div class="bg-slate-800 p-4 rounded-2xl border border-slate-700 flex justify-between items-center">
                    <div class="flex items-center gap-4">
                        <i class="fas ${v.type === 'audio' ? 'fa-music text-amber-500' : 'fa-video text-indigo-500'}"></i>
                        <div>
                            <p class="font-bold text-sm">${v.filename}</p>
                            <p class="text-[10px] text-slate-500 uppercase">${(v.size/1024/1024).toFixed(2)} MB â€¢ ${v.type}</p>
                        </div>
                    </div>
                    <button onclick="deleteMedia(${v.id})" class="text-slate-600 hover:text-rose-500 transition-colors"><i class="fas fa-trash"></i></button>
                </div>
            `).join('');
        }

        async function deleteMedia(id) {
            if (!confirm('Hapus file? Storage akan bertambah kembali.')) return;
            await fetch('/api/videos/' + id, { method: 'DELETE' });
            checkAuth(); // Refresh quota info
        }

        async function handleUpload(input) {
            if (!input.files[0]) return;
            const fd = new FormData(); fd.append('video', input.files[0]);
            try {
                const res = await fetch('/api/videos/upload', { method: 'POST', body: fd });
                const data = await res.json();
                if (data.success) {
                    checkAuth();
                    input.value = '';
                } else alert(data.error);
            } catch (e) {
                alert("Upload gagal. Periksa koneksi atau ukuran file.");
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + tab).classList.add('active');
            
            if (tab === 'users') fetchUsers();
        }

        async function fetchUsers() {
            const res = await fetch('/api/users');
            const users = await res.json();
            document.getElementById('user-table-body').innerHTML = users.map(u => `
                <tr class="border-b border-slate-700/50">
                    <td class="p-4 font-bold text-white">${u.username}</td>
                    <td class="p-4 text-indigo-400">${u.plan_name}</td>
                    <td class="p-4 text-slate-400">${(u.storage_used/1024/1024).toFixed(1)} MB</td>
                    <td class="p-4 text-right">
                        <button onclick="openUpgradeModal(${u.id}, '${u.username}')" class="text-indigo-400 hover:underline">Edit Plan</button>
                    </td>
                </tr>
            `).join('');
        }

        async function openUpgradeModal(id, name) {
            currentUpgradeUserId = id;
            document.getElementById('upgrade-user-name').textContent = `User: ${name}`;
            const res = await fetch('/api/plans');
            const plans = await res.json();
            document.getElementById('plan-select').innerHTML = plans.map(p => `<option value="${p.id}">${p.name} (${p.max_storage_mb}MB)</option>`).join('');
            document.getElementById('upgradeModal').classList.remove('hidden');
        }

        function closeUpgradeModal() { document.getElementById('upgradeModal').classList.add('hidden'); }

        async function submitUpgrade() {
            const plan_id = document.getElementById('plan-select').value;
            await fetch('/api/admin/assign-plan', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: currentUpgradeUserId, plan_id })
            });
            closeUpgradeModal();
            fetchUsers();
            if (currentUpgradeUserId === currentUser.id) checkAuth();
        }

        async function handleLogout() {
            await fetch('/api/logout', {method: 'POST'});
            location.reload();
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
