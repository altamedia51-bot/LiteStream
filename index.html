
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteStream SaaS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; margin: 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .nav-link.active { background: rgba(79, 70, 229, 0.1); color: #818cf8; border-right: 3px solid #6366f1; }
        #main-app { display: none; }
        #logConsole::-webkit-scrollbar { width: 4px; }
        #logConsole::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .media-checkbox:checked + .media-card { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">

    <!-- Auth View (Tetap Sama) -->
    <div id="login-view" class="fixed inset-0 z-[100] bg-slate-950 flex items-center justify-center p-6">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-md rounded-[2.5rem] p-10 space-y-8 shadow-2xl">
            <div class="text-center">
                <h2 id="auth-title" class="text-2xl font-bold">LiteStream Login</h2>
                <p id="auth-subtitle" class="text-slate-500 text-sm">Kelola stream Anda dengan paket hemat</p>
            </div>
            <form id="login-form" onsubmit="handleAuth(event)" class="space-y-4">
                <input type="text" id="login-user" required class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3.5 text-sm text-white" placeholder="Username" value="admin">
                <input type="password" id="login-pass" required class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3.5 text-sm text-white" placeholder="Password" value="admin123">
                <button type="submit" id="login-btn" class="w-full py-4 bg-indigo-600 rounded-2xl font-bold shadow-xl transition-all hover:bg-indigo-500">SIGN IN</button>
                <p class="text-center text-xs text-slate-500">Belum punya akun? <a href="#" onclick="toggleAuthMode()" class="text-indigo-400">Daftar Trial</a></p>
            </form>
            <div id="auth-error" class="hidden text-rose-500 text-xs text-center p-3 bg-rose-500/10 rounded-xl border border-rose-500/20"></div>
        </div>
    </div>

    <!-- Main Layout -->
    <div id="main-app" class="flex flex-col md:flex-row min-h-screen">
        <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col p-6">
            <h1 class="font-bold text-xl mb-10 flex items-center gap-2"><i class="fas fa-bolt text-indigo-500"></i> LiteStream</h1>
            <nav class="space-y-2 flex-1">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 active"><i class="fas fa-chart-pie"></i> Overview</button>
                <button onclick="switchTab('library')" id="nav-library" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400"><i class="fas fa-folder"></i> Media</button>
                <button onclick="switchTab('users')" id="nav-users" class="nav-link hidden w-full items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400"><i class="fas fa-user-shield"></i> Users</button>
                <button onclick="switchTab('settings')" id="nav-settings" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400"><i class="fas fa-cog"></i> Settings</button>
            </nav>
            <div class="mt-auto space-y-4">
                <div class="p-4 bg-slate-900/50 rounded-2xl border border-slate-700/50">
                   <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">Status Server</p>
                   <div class="flex items-center gap-2">
                       <span id="status-indicator" class="w-2.5 h-2.5 rounded-full bg-slate-600 animate-pulse"></span>
                       <span id="status-text" class="text-xs font-bold text-slate-400">OFFLINE</span>
                   </div>
                </div>
                <button onclick="handleLogout()" class="w-full text-rose-400 text-sm font-bold flex items-center gap-2 px-4 py-3 hover:bg-rose-500/10 rounded-xl transition-colors"><i class="fas fa-power-off"></i> Logout</button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto p-8">
            <!-- Quota Widget -->
            <div id="quota-widget" class="bg-slate-800 border border-slate-700 rounded-3xl p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-6 shadow-xl">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Paket Saat Ini</p>
                    <h3 id="plan-name-display" class="text-xl font-bold text-indigo-400">Loading...</h3>
                </div>
                <div class="flex-1 max-w-md w-full space-y-2">
                    <div class="flex justify-between text-[10px] font-bold uppercase">
                        <span class="text-slate-400">Penyimpanan Terpakai</span>
                        <span id="storage-text" class="text-slate-200">0 / 0 MB</span>
                    </div>
                    <div class="h-2 bg-slate-900 rounded-full overflow-hidden">
                        <div id="storage-bar" class="h-full bg-indigo-500 transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <button onclick="alert('Hubungi admin untuk upgrade!')" class="bg-indigo-600/10 text-indigo-400 border border-indigo-500/20 px-6 py-2 rounded-xl text-xs font-bold hover:bg-indigo-600 hover:text-white transition-all">UPGRADE PLAN</button>
            </div>

            <!-- Tab: Overview -->
            <div id="tab-overview" class="tab-content active space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-6">
                        <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-lg">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Streaming Control</h4>
                            <div id="stream-info-card" class="space-y-4">
                                <div id="live-indicator-large" class="hidden flex items-center gap-3 p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl mb-4">
                                    <span class="w-3 h-3 bg-emerald-500 rounded-full animate-ping"></span>
                                    <span class="text-emerald-400 font-bold text-sm">TRANSMITTING...</span>
                                </div>
                                <p id="stream-status-msg" class="text-sm text-slate-400">Tidak ada aktivitas stream aktif.</p>
                                <button onclick="stopStream()" id="btn-stop-stream" class="hidden w-full py-4 bg-rose-600 hover:bg-rose-500 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center justify-center gap-2">
                                    <i class="fas fa-stop"></i> HENTIKAN STREAM
                                </button>
                            </div>
                        </div>
                        <div class="bg-slate-800 p-6 rounded-3xl border border-slate-700 shadow-lg">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Fitur Paket</h4>
                            <ul id="plan-features" class="space-y-3 text-sm text-slate-300"></ul>
                        </div>
                    </div>
                    <div class="md:col-span-2 bg-slate-950 p-6 rounded-3xl border border-slate-700 h-[450px] flex flex-col shadow-inner">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-[10px] font-bold text-slate-500 uppercase">Real-time Stream Logs</h4>
                            <button onclick="document.getElementById('logConsole').innerHTML=''" class="text-[10px] text-slate-600 hover:text-slate-400">Clear</button>
                        </div>
                        <div class="flex-1 overflow-y-auto font-mono text-[11px] space-y-1" id="logConsole">
                            <p class="text-slate-600">-- Menunggu aktivitas stream --</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: Library -->
            <div id="tab-library" class="tab-content space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">Media Library</h2>
                        <p class="text-xs text-slate-500">Pilih satu atau beberapa file untuk memulai streaming.</p>
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-start-playlist" onclick="startPlaylist()" class="hidden bg-emerald-600 hover:bg-emerald-500 px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg transition-all flex items-center gap-2">
                            <i class="fas fa-play"></i> STREAM SELECTED
                        </button>
                        <button onclick="document.getElementById('file-up').click()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg transition-all"><i class="fas fa-plus mr-2"></i> Upload Media</button>
                        <input type="file" id="file-up" class="hidden" onchange="handleUpload(this)">
                    </div>
                </div>
                <div id="media-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- Tab: Settings (Tetap Sama) -->
            <div id="tab-settings" class="tab-content space-y-6">
                <h2 class="text-2xl font-bold">Stream Settings</h2>
                <div class="bg-slate-800 p-8 rounded-3xl border border-slate-700 max-w-2xl shadow-xl">
                    <form onsubmit="saveSettings(event)" class="space-y-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500 uppercase">RTMP URL (Youtube/Twitch/Tiktok)</label>
                            <input type="text" id="setting-rtmp" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3.5 text-sm text-white focus:border-indigo-500 outline-none" placeholder="rtmp://a.rtmp.youtube.com/live2/XXXX-XXXX-XXXX-XXXX">
                            <p class="text-[10px] text-slate-500 italic">Masukkan URL RTMP lengkap termasuk Stream Key Anda.</p>
                        </div>
                        <div class="space-y-2">
                           <label class="text-xs font-bold text-slate-500 uppercase">Cover Background (MP3 Mode)</label>
                           <div class="flex items-center gap-4">
                               <select id="setting-cover" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm text-white">
                                   <option value="">Default Black</option>
                               </select>
                           </div>
                        </div>
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 px-8 py-3 rounded-xl font-bold text-sm transition-all shadow-lg">SIMPAN PENGATURAN</button>
                    </form>
                </div>
            </div>

            <!-- Tab: Users (Tetap Sama) -->
            <div id="tab-users" class="tab-content space-y-6">
                <h2 class="text-2xl font-bold">User & Plan Management</h2>
                <div class="bg-slate-800 rounded-3xl overflow-hidden border border-slate-700 shadow-xl">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/50 text-[10px] uppercase font-bold text-slate-500">
                            <tr>
                                <th class="p-4">User</th>
                                <th class="p-4">Paket</th>
                                <th class="p-4">Storage</th>
                                <th class="p-4 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="text-sm"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        const socket = io();
        let currentUser = null;
        let authMode = 'login';
        let selectedMedia = new Set();

        // Socket Events
        socket.on('log', (data) => {
            const consoleEl = document.getElementById('logConsole');
            const p = document.createElement('p');
            
            if (data.type === 'debug' && !data.message.includes('bitrate=')) return; // Filter spam log

            p.className = data.type === 'error' ? 'text-rose-500 font-bold' : (data.type === 'start' ? 'text-emerald-400 font-bold' : 'text-slate-400');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${data.message}`;
            consoleEl.appendChild(p);
            consoleEl.scrollTop = consoleEl.scrollHeight;

            if (data.type === 'start') setLiveStatus(true, data.message);
            if (data.type === 'end' || data.type === 'error' || data.message.includes('dihentikan')) setLiveStatus(false);
        });

        function setLiveStatus(isLive, message = "") {
            const indicator = document.getElementById('status-indicator');
            const text = document.getElementById('status-text');
            const stopBtn = document.getElementById('btn-stop-stream');
            const infoMsg = document.getElementById('stream-status-msg');
            const largeInd = document.getElementById('live-indicator-large');

            if (isLive) {
                indicator.className = "w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]";
                text.textContent = "LIVE";
                text.className = "text-xs font-bold text-emerald-400";
                stopBtn.classList.remove('hidden');
                largeInd.classList.remove('hidden');
                infoMsg.textContent = message || "Streaming aktif...";
            } else {
                indicator.className = "w-2.5 h-2.5 rounded-full bg-slate-600 animate-pulse";
                text.textContent = "OFFLINE";
                text.className = "text-xs font-bold text-slate-400";
                stopBtn.classList.add('hidden');
                largeInd.classList.add('hidden');
                infoMsg.textContent = "Tidak ada aktivitas stream aktif.";
            }
        }

        async function checkAuth() {
            try {
                const res = await fetch('/api/check-auth');
                const data = await res.json();
                if (data.authenticated) {
                    currentUser = data.user;
                    showDashboard();
                } else {
                    document.getElementById('login-view').classList.remove('hidden');
                }
            } catch (e) { document.getElementById('login-view').classList.remove('hidden'); }
        }

        function showDashboard() {
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('main-app').style.display = 'flex';
            document.getElementById('plan-name-display').textContent = currentUser.plan_name;
            
            const usedMB = (currentUser.storage_used / (1024 * 1024)).toFixed(1);
            const totalMB = currentUser.max_storage_mb;
            const percent = (usedMB / totalMB) * 100;
            
            document.getElementById('storage-text').textContent = `${usedMB} / ${totalMB} MB`;
            const bar = document.getElementById('storage-bar');
            bar.style.width = percent + '%';
            bar.className = `h-full transition-all duration-500 ${percent > 90 ? 'bg-rose-500' : (percent > 70 ? 'bg-amber-500' : 'bg-indigo-500')}`;

            const feats = document.getElementById('plan-features');
            feats.innerHTML = `
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-indigo-400"></i> Max Streams: ${currentUser.max_active_streams}</li>
                <li class="flex items-center gap-2"><i class="fas fa-check-circle text-indigo-400"></i> Allowed: ${currentUser.allowed_types.toUpperCase()}</li>
                <li class="flex items-center gap-2"><i class="fas fa-cloud text-indigo-400"></i> SaaS Cloud Storage</li>
            `;

            if (currentUser.role === 'admin') document.getElementById('nav-users').classList.remove('hidden');
            fetchMedia();
            fetchSettings();
        }

        async function fetchMedia() {
            const res = await fetch('/api/videos');
            const data = await res.json();
            const list = document.getElementById('media-list');
            const coverSelect = document.getElementById('setting-cover');
            
            coverSelect.innerHTML = '<option value="">Default Black</option>';
            
            list.innerHTML = data.map(v => {
                if (v.type === 'image') {
                    coverSelect.innerHTML += `<option value="${v.id}">${v.filename}</option>`;
                }
                return `
                <label class="relative cursor-pointer">
                    <input type="checkbox" class="media-checkbox hidden" onchange="toggleSelect(${v.id}, '${v.type}')" ${v.type==='image' ? 'disabled' : ''}>
                    <div class="media-card bg-slate-800 p-5 rounded-3xl border border-slate-700 flex flex-col gap-4 shadow-lg group hover:border-indigo-500/50 transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-2xl bg-slate-900 flex items-center justify-center">
                                <i class="fas ${v.type === 'audio' ? 'fa-music text-amber-500' : (v.type === 'image' ? 'fa-image text-emerald-500' : 'fa-video text-indigo-500')}"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-bold text-sm truncate text-white">${v.filename}</p>
                                <p class="text-[10px] text-slate-500 uppercase tracking-tighter">${(v.size/1024/1024).toFixed(2)} MB â€¢ ${v.type}</p>
                            </div>
                            <button onclick="deleteMedia(event, ${v.id})" class="text-slate-600 hover:text-rose-500 z-10"><i class="fas fa-trash"></i></button>
                        </div>
                        ${v.type !== 'image' ? `
                        <div class="flex items-center justify-between text-[10px] text-slate-500">
                           <span>Klik card untuk pilih ke Playlist</span>
                           <i class="fas fa-check-circle opacity-0 group-[.media-checkbox:checked+&]:opacity-100 text-indigo-500"></i>
                        </div>
                        ` : ''}
                    </div>
                </label>
                `;
            }).join('');
        }

        function toggleSelect(id, type) {
            if (selectedMedia.has(id)) selectedMedia.delete(id);
            else selectedMedia.add(id);
            
            const btn = document.getElementById('btn-start-playlist');
            if (selectedMedia.size > 0) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }

        async function startPlaylist() {
            const rtmpUrl = document.getElementById('setting-rtmp').value;
            if (!rtmpUrl) { alert("Atur RTMP URL di menu Settings dulu!"); switchTab('settings'); return; }
            
            const ids = Array.from(selectedMedia);
            const coverImageId = document.getElementById('setting-cover').value;
            
            try {
                const res = await fetch('/api/playlist/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ids, rtmpUrl, coverImageId, loop: true })
                });
                const data = await res.json();
                if (!data.success) alert(data.error);
                else {
                    selectedMedia.clear();
                    switchTab('overview');
                }
            } catch (e) { alert("Gagal memulai stream."); }
        }

        async function stopStream() {
            if (!confirm("Hentikan streaming sekarang?")) return;
            try {
                const res = await fetch('/api/stream/stop', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    setLiveStatus(false);
                    alert("Stream dihentikan.");
                }
            } catch (e) { alert("Error menghentikan stream."); }
        }

        // Functions lainnya (handleAuth, handleLogout, saveSettings, handleUpload) tetap sama dengan versi sebelumnya agar feature SaaS tidak hilang.
        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('login-user').value;
            const password = document.getElementById('login-pass').value;
            const res = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });
            const data = await res.json();
            if (data.success) location.reload(); else alert(data.error);
        }

        async function saveSettings(e) {
            e.preventDefault();
            const rtmp_url = document.getElementById('setting-rtmp').value;
            await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ rtmp_url })
            });
            alert("Tersimpan!");
        }

        async function handleUpload(input) {
            if (!input.files[0]) return;
            const fd = new FormData(); fd.append('video', input.files[0]);
            const res = await fetch('/api/videos/upload', { method: 'POST', body: fd });
            if ((await res.json()).success) { checkAuth(); input.value = ''; } else alert("Upload gagal/Kuota penuh.");
        }

        async function deleteMedia(e, id) {
            e.preventDefault(); e.stopPropagation();
            if (!confirm('Hapus media?')) return;
            await fetch('/api/videos/' + id, { method: 'DELETE' });
            checkAuth();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + tab).classList.add('active');
            if (tab === 'users') fetchUsers();
        }

        async function handleLogout() {
            await fetch('/api/logout', {method: 'POST'});
            location.reload();
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
