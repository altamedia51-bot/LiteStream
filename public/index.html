
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteStream VPS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .console-log::-webkit-scrollbar { width: 6px; }
        .console-log::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen">
    <!-- Navbar Mobile -->
    <nav class="md:hidden bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg"><i class="fas fa-tower-broadcast text-white"></i></div>
            <span class="font-bold tracking-tight">LiteStream</span>
        </div>
        <button id="mobileMenuBtn"><i class="fas fa-bars text-xl"></i></button>
    </nav>

    <div class="flex flex-col md:flex-row min-h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-64 bg-slate-800 border-r border-slate-700 p-6 flex-shrink-0">
            <div class="hidden md:flex items-center gap-2 mb-10">
                <div class="bg-indigo-600 p-2 rounded-lg"><i class="fas fa-tower-broadcast text-white text-xl"></i></div>
                <h1 class="font-bold text-xl tracking-tight">LiteStream</h1>
            </div>

            <nav class="space-y-2">
                <button onclick="switchTab('dashboard')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-indigo-600 text-white font-semibold shadow-lg shadow-indigo-500/20" id="btn-dashboard">
                    <i class="fas fa-chart-line w-5"></i> Dashboard
                </button>
                <button onclick="switchTab('library')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-700/50 hover:text-slate-200" id="btn-library">
                    <i class="fas fa-photo-video w-5"></i> Media Library
                </button>
                <button onclick="switchTab('settings')" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all text-slate-400 hover:bg-slate-700/50 hover:text-slate-200" id="btn-settings">
                    <i class="fas fa-cog w-5"></i> Settings
                </button>
            </nav>

            <div class="mt-10 md:mt-20">
                <div class="bg-slate-900/50 border border-slate-700 rounded-2xl p-4">
                    <p class="text-[10px] font-bold text-slate-500 uppercase mb-3">Server Info</p>
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-slate-400">Status:</span>
                        <span class="text-xs font-bold text-emerald-400" id="serverStatus">Online</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs text-slate-400">Memory:</span>
                        <span class="text-xs text-slate-300">1GB VPS</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            
            <!-- Dashboard Tab -->
            <section id="dashboard" class="tab-content active space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold">System Overview</h2>
                        <p class="text-slate-400 text-sm">Real-time monitoring and control center.</p>
                    </div>
                    <div id="liveIndicator" class="hidden items-center gap-2 text-xs font-bold text-rose-500 bg-rose-500/10 px-4 py-2 rounded-full border border-rose-500/20 animate-pulse">
                        <span class="w-2 h-2 rounded-full bg-rose-500"></span> LIVE STREAMING
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl">
                        <p class="text-xs font-bold text-slate-500 uppercase mb-2">Stream State</p>
                        <div class="text-3xl font-bold" id="activeStatusDisplay">IDLE</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl">
                        <p class="text-xs font-bold text-slate-500 uppercase mb-2">Media Files</p>
                        <div class="text-3xl font-bold" id="totalVideosCount">0</div>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl">
                        <p class="text-xs font-bold text-slate-500 uppercase mb-2">Optimization</p>
                        <div class="text-3xl font-bold text-emerald-400">2 FPS Mode</div>
                    </div>
                </div>

                <!-- Console Logs -->
                <div class="bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden shadow-xl">
                    <div class="bg-slate-700/50 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="font-bold flex items-center gap-2"><i class="fas fa-terminal text-indigo-400"></i> Live Console Output</h3>
                        <div class="flex gap-2">
                             <button onclick="stopStreaming()" class="text-xs bg-rose-600 hover:bg-rose-700 px-3 py-1 rounded-lg transition-colors font-bold">Stop Stream</button>
                             <button onclick="clearLogs()" class="text-xs text-slate-400 hover:text-white transition-colors">Clear</button>
                        </div>
                    </div>
                    <div id="logConsole" class="console-log bg-slate-950 p-6 font-mono text-xs h-72 overflow-y-auto space-y-1 text-slate-300">
                        <p class="text-slate-500 italic">[Waiting for server events...]</p>
                    </div>
                </div>
            </section>

            <!-- Library Tab -->
            <section id="library" class="tab-content space-y-8">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold">Media Library</h2>
                        <p class="text-slate-400 text-sm">Upload Videos, Audio, or Cover Images.</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="document.getElementById('uploadInput').click()" class="bg-indigo-600 hover:bg-indigo-700 px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg shadow-indigo-500/20">
                            <i class="fas fa-cloud-upload-alt"></i> Upload Media
                        </button>
                    </div>
                    <input type="file" id="uploadInput" class="hidden" accept="video/*,audio/mpeg,image/*" onchange="handleUpload(this)">
                </div>

                <!-- Upload Progress -->
                <div id="uploadProgress" class="hidden bg-slate-800 border border-slate-700 rounded-2xl p-4">
                    <div class="flex justify-between text-xs mb-2">
                        <span id="uploadFileName">Uploading...</span>
                        <span id="uploadPercentage">0%</span>
                    </div>
                    <div class="h-1.5 w-full bg-slate-900 rounded-full overflow-hidden">
                        <div id="uploadProgressBar" class="h-full bg-indigo-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="flex gap-4 border-b border-slate-700">
                    <button onclick="filterLibrary('all')" class="pb-2 border-b-2 border-indigo-500 text-indigo-400 px-2 font-bold" id="filter-all">All Files</button>
                    <button onclick="filterLibrary('video')" class="pb-2 text-slate-500 px-2" id="filter-video">Videos</button>
                    <button onclick="filterLibrary('audio')" class="pb-2 text-slate-500 px-2" id="filter-audio">Audio</button>
                    <button onclick="filterLibrary('image')" class="pb-2 text-slate-500 px-2" id="filter-image">Images</button>
                </div>

                <!-- Video List -->
                <div id="videoList" class="grid grid-cols-1 gap-4">
                    <div class="text-center py-20 text-slate-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
                        <p>Loading library...</p>
                    </div>
                </div>
            </section>

            <!-- Settings Tab -->
            <section id="settings" class="tab-content space-y-8">
                <div>
                    <h2 class="text-2xl font-bold">Server Settings</h2>
                    <p class="text-slate-400 text-sm">Global configuration for your streaming server.</p>
                </div>

                <div class="max-w-2xl bg-slate-800 border border-slate-700 rounded-2xl p-8 space-y-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-400">Default RTMP Endpoint</label>
                        <input type="text" id="settingRtmp" placeholder="rtmp://a.rtmp.youtube.com/live2/XXXX" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                    </div>
                    <button onclick="saveSettings()" class="bg-indigo-600 hover:bg-indigo-700 px-8 py-3 rounded-xl font-bold transition-all w-full md:w-auto">
                        Save Changes
                    </button>
                </div>
            </section>
        </main>
    </div>

    <!-- Go Live Modal -->
    <div id="streamModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-lg rounded-3xl p-8 shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Start Stream Session</h3>
            <p id="selectedVideoName" class="text-slate-400 text-sm mb-6 font-medium bg-slate-900 px-3 py-1 rounded inline-block"></p>
            
            <div class="space-y-4">
                <div id="coverSelection" class="hidden space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">Select Cover Image</label>
                    <select id="coverImageSelect" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">-- No Image (Black Background) --</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">RTMP Destination URL</label>
                    <input type="text" id="targetRtmp" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button onclick="closeStreamModal()" class="flex-1 px-6 py-3 border border-slate-700 rounded-xl font-bold hover:bg-slate-700 transition-all">Cancel</button>
                    <button id="confirmStreamBtn" class="flex-1 px-6 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl font-bold transition-all shadow-lg shadow-indigo-500/20">Go Live</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const logConsole = document.getElementById('logConsole');
        const liveIndicator = document.getElementById('liveIndicator');
        const activeStatusDisplay = document.getElementById('activeStatusDisplay');
        
        let allMedia = [];
        let currentFilter = 'all';

        socket.on('log', (data) => {
            const p = document.createElement('p');
            const time = new Date().toLocaleTimeString();
            
            if (data.type === 'error') p.className = 'text-rose-400';
            else if (data.type === 'start') {
                p.className = 'text-emerald-400 font-bold';
                liveIndicator.classList.remove('hidden');
                liveIndicator.classList.add('flex');
                activeStatusDisplay.textContent = 'STREAMING';
                activeStatusDisplay.className = 'text-3xl font-bold text-emerald-400';
            }
            else if (data.type === 'end') {
                p.className = 'text-amber-400';
                liveIndicator.classList.add('hidden');
                liveIndicator.classList.remove('flex');
                activeStatusDisplay.textContent = 'IDLE';
                activeStatusDisplay.className = 'text-3xl font-bold';
            }

            p.innerHTML = `<span class="opacity-30 text-[10px]">[${time}]</span> ${data.message || data.text || JSON.stringify(data)}`;
            logConsole.appendChild(p);
            logConsole.scrollTop = logConsole.scrollHeight;
        });

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => {
                el.classList.remove('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-500/20', 'font-semibold');
                el.classList.add('text-slate-400');
            });

            document.getElementById(tabId).classList.add('active');
            const activeBtn = document.getElementById(`btn-${tabId}`);
            activeBtn.classList.add('bg-indigo-600', 'text-white', 'shadow-lg', 'shadow-indigo-500/20', 'font-semibold');
            activeBtn.classList.remove('text-slate-400');

            if (tabId === 'library') fetchVideos();
            if (tabId === 'settings') loadSettings();
        }

        async function fetchVideos() {
            try {
                const res = await fetch('/api/videos');
                allMedia = await res.json();
                document.getElementById('totalVideosCount').textContent = allMedia.length;
                renderLibrary();
            } catch (err) {
                console.error(err);
            }
        }

        function filterLibrary(type) {
            currentFilter = type;
            document.querySelectorAll('[id^="filter-"]').forEach(el => {
                el.classList.remove('border-b-2', 'border-indigo-500', 'text-indigo-400', 'font-bold');
                el.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`filter-${type}`);
            activeBtn.classList.add('border-b-2', 'border-indigo-500', 'text-indigo-400', 'font-bold');
            activeBtn.classList.remove('text-slate-500');
            renderLibrary();
        }

        function renderLibrary() {
            const container = document.getElementById('videoList');
            const filtered = currentFilter === 'all' ? allMedia : allMedia.filter(m => m.type === currentFilter);

            if (filtered.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-slate-500"><i class="fas fa-folder-open text-4xl mb-4"></i><p>No files found.</p></div>';
                return;
            }

            container.innerHTML = filtered.map(item => {
                let icon = 'fa-file-video';
                let color = 'text-indigo-400';
                if (item.type === 'audio') { icon = 'fa-music'; color = 'text-amber-400'; }
                if (item.type === 'image') { icon = 'fa-image'; color = 'text-emerald-400'; }

                return `
                    <div class="bg-slate-800 border border-slate-700 rounded-2xl p-5 flex items-center justify-between hover:bg-slate-700/30 transition-all group">
                        <div class="flex items-center gap-4">
                            <div class="bg-slate-900 p-4 rounded-xl ${color} group-hover:scale-105 transition-transform">
                                <i class="fas ${icon} text-2xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-100">${item.filename}</h4>
                                <p class="text-xs text-slate-500 mt-0.5 uppercase tracking-widest font-bold">${item.type} â€¢ ${(item.size / (1024 * 1024)).toFixed(2)} MB</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            ${(item.type === 'video' || item.type === 'audio') ? `
                                <button onclick="openStreamModal(${item.id}, '${item.filename}', '${item.type}')" class="bg-indigo-600/10 text-indigo-400 hover:bg-indigo-600 hover:text-white p-3 rounded-xl transition-all">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : ''}
                            <button onclick="deleteVideo(${item.id})" class="bg-rose-500/10 text-rose-500 hover:bg-rose-500 hover:text-white p-3 rounded-xl transition-all">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function handleUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const percentageText = document.getElementById('uploadPercentage');
            const fileNameText = document.getElementById('uploadFileName');

            progressDiv.classList.remove('hidden');
            fileNameText.textContent = `Uploading ${file.name}...`;

            const formData = new FormData();
            formData.append('video', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/videos/upload', true);

            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = percent + '%';
                    percentageText.textContent = percent + '%';
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    fetchVideos();
                } else {
                    alert('Upload failed: ' + xhr.responseText);
                }
                progressDiv.classList.add('hidden');
                input.value = '';
            };

            xhr.send(formData);
        }

        async function deleteVideo(id) {
            if (!confirm('Delete this file?')) return;
            try {
                await fetch(`/api/videos/${id}`, { method: 'DELETE' });
                fetchVideos();
            } catch (err) { alert('Delete failed'); }
        }

        let currentMediaId = null;
        function openStreamModal(id, name, type) {
            currentMediaId = id;
            document.getElementById('selectedVideoName').textContent = name;
            document.getElementById('streamModal').classList.remove('hidden');
            
            const coverSection = document.getElementById('coverSelection');
            if (type === 'audio') {
                coverSection.classList.remove('hidden');
                const select = document.getElementById('coverImageSelect');
                select.innerHTML = '<option value="">-- No Image (Black) --</option>';
                allMedia.filter(m => m.type === 'image').forEach(img => {
                    const opt = document.createElement('option');
                    opt.value = img.id;
                    opt.textContent = img.filename;
                    select.appendChild(opt);
                });
            } else {
                coverSection.classList.add('hidden');
            }

            fetch('/api/settings').then(res => res.json()).then(data => {
                document.getElementById('targetRtmp').value = data.rtmp_url || '';
            });
            
            document.getElementById('confirmStreamBtn').onclick = () => startTheStream();
        }

        function closeStreamModal() {
            document.getElementById('streamModal').classList.add('hidden');
        }

        async function startTheStream() {
            const rtmp = document.getElementById('targetRtmp').value;
            const coverId = document.getElementById('coverImageSelect').value;
            if (!rtmp) return alert('RTMP URL required');

            try {
                const res = await fetch('/api/stream/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: currentMediaId, rtmpUrl: rtmp, coverImageId: coverId })
                });
                const data = await res.json();
                if (data.success) {
                    closeStreamModal();
                    switchTab('dashboard');
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) { alert('Request failed'); }
        }

        async function stopStreaming() {
            if (!confirm('Stop current stream?')) return;
            await fetch('/api/stream/stop', { method: 'POST' });
        }

        function clearLogs() { logConsole.innerHTML = ''; }

        async function loadSettings() {
            const res = await fetch('/api/settings');
            const data = await res.json();
            document.getElementById('settingRtmp').value = data.rtmp_url || '';
        }

        async function saveSettings() {
            const rtmp = document.getElementById('settingRtmp').value;
            await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rtmp_url: rtmp })
            });
            alert('Saved');
        }

        window.onload = () => {
            fetchVideos();
        };
    </script>
</body>
</html>
